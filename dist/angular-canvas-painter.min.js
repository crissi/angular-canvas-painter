"use strict";!function(e){angular.module("pw.canvas-painter",[]),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"=",imageSrc:"="},templateUrl:"../templates/canvas.html",link:function(t,n){var o=!!("ontouchstart"in e),a=o?"touchstart":"mousedown",i=o?"touchmove":"mousemove",r=o?"touchend":"mouseup",c=t.options;c.canvasId=c.customCanvasId||"pwCanvasMain",c.tmpCanvasId=c.customCanvasId?c.canvasId+"Tmp":"pwCanvasTmp",c.width=c.width||400,c.height=c.height||300,c.backgroundColor=c.backgroundColor||"#fff",c.color=c.color||"#000",c.undoEnabled=c.undoEnabled||!1,c.opacity=c.opacity||.9,c.lineWidth=c.lineWidth||1,c.undo=c.undo||!1;var l=t.imageSrc;if(console.log("starting directive, imageSrc is",l),l){console.log("Scope image src is "+l);var s=new Image;s.onload=function(){v.drawImage(this,0,0)},s.src=l,t.$watch(function(){return t.imageSrc},function(e){console.log("new image src ",e);var t=new Image;t.onload=function(){v.drawImage(this,0,0)},t.src=e})}if(c.undo){var u=[];t.$watch(function(){return u.length},function(e){t.version=e}),t.$watch("version",function(e){return 0>e?(t.version=0,void 0):e>=u.length?(t.version=u.length,void 0):(E(e),void 0)})}var d=document.createElement("canvas");d.id=c.canvasId;var p=document.createElement("canvas");p.id=c.tmpCanvasId,angular.element(p).css({position:"absolute",top:0,left:0}),n.find("div").append(d),n.find("div").append(p);var v=d.getContext("2d"),h=p.getContext("2d"),f={x:0,y:0},m=[];d.width=p.width=c.width,d.height=p.height=c.height,v.fillStyle=c.backgroundColor,v.fillRect(0,0,d.width,d.height),h.globalAlpha=c.opacity,h.lineJoin=h.lineCap="round",h.lineWidth=10,h.strokeStyle=c.color,t.$watch("options.lineWidth",function(e){"string"==typeof e&&(e=parseInt(e,10)),e&&"number"==typeof e&&(h.lineWidth=c.lineWidth=e)}),t.$watch("options.color",function(e){e&&(h.strokeStyle=h.fillStyle=e)}),t.$watch("options.opacity",function(e){e&&(h.globalAlpha=e)});var g=function(e){var t=0,n=0;do isNaN(e.offsetLeft)||(t+=e.offsetTop,n+=e.offsetLeft),e=e.offsetParent;while(e);return{left:n,top:t}},w=function(e,t){o?(e.x=t.changedTouches[0].pageX-g(t.target).left,e.y=t.changedTouches[0].pageY-g(t.target).top):(e.x=void 0!==t.offsetX?t.offsetX:t.layerX,e.y=void 0!==t.offsetY?t.offsetY:t.layerY)},y=function(e){if(e&&(e.preventDefault(),w(f,e)),m.push({x:f.x,y:f.y}),3===m.length){var t=m[0];return h.beginPath(),h.arc(t.x,t.y,h.lineWidth/2,0,2*Math.PI,!0),h.fill(),h.closePath(),void 0}h.clearRect(0,0,p.width,p.height),h.beginPath(),h.moveTo(m[0].x,m[0].y);for(var n=1;n<m.length-2;n++){var o=(m[n].x+m[n+1].x)/2,a=(m[n].y+m[n+1].y)/2;h.quadraticCurveTo(m[n].x,m[n].y,o,a)}h.quadraticCurveTo(m[n].x,m[n].y,m[n+1].x,m[n+1].y),h.stroke()},C=function(){c.undo&&t.$apply(function(){u.push(v.getImageData(0,0,p.width,p.height)),angular.isNumber(c.undo)&&c.undo>0&&(u=u.slice(-1*c.undo))}),p.removeEventListener(i,y,!1),v.drawImage(p,0,0),h.clearRect(0,0,p.width,p.height),m=[]},x=function(e){e.preventDefault(),p.addEventListener(i,y,!1),w(f,e),m.push({x:f.x,y:f.y}),m.push({x:f.x,y:f.y}),y()},b=function(){function e(){s=!0}function n(){s=!1}function i(){document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",n)}function c(e){s&&x(e)}function l(e){s&&C(e)}if(p.addEventListener(a,x,!1),p.addEventListener(r,C,!1),!o){var s;document.body.addEventListener("mousedown",e),document.body.addEventListener("mouseup",n),t.$on("$destroy",i),p.addEventListener("mouseenter",c),p.addEventListener("mouseleave",l)}},E=function(e){u.length>0&&(v.putImageData(u[e],0,0),u=u.slice(0,e))};b()}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(e){e.setColor=function(t){e.selectedColor=t}}}})}(this);